<div
  class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark font-display antialiased min-h-screen flex flex-col"
  style='--checkbox-tick-svg: url(&apos;data:image/svg+xml,%3csvg viewBox=%270 0 16 16%27 fill=%27rgb(248,250,252)%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3cpath d=%27M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z%27/%3e%3c/svg%3e&apos;); font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'
>
  <app-navbar></app-navbar>

  <main class="flex-grow">
    <div class="px-40 flex flex-1 justify-center py-5">
      <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
        <div class="flex items-center justify-between px-4 mb-4">
          <button
            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7eff3] text-[#0d171b] text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-200 transition"
            (click)="goBack()"
          >
            <span class="truncate">← Volver</span>
          </button>
        </div>
        <h2 class="text-[#0d171b] tracking-light text-[28px] font-bold leading-tight px-4 text-center pb-3 pt-5">Confirmar tu Reserva</h2>
        
        <!-- Mensaje de error -->
        <div *ngIf="errorMessage" class="px-4 py-3 bg-red-100 border border-red-400 text-red-700 rounded mb-4">
          {{ errorMessage }}
        </div>

        <!-- Información de debug -->
        <div class="px-4 py-3 bg-blue-100 border border-blue-400 text-blue-700 rounded mb-4">
          <h4 class="font-bold">Información de Debug:</h4>
          <p><strong>Parámetros completos:</strong> {{ searchParams | json }}</p>
          <p><strong>Fechas recibidas:</strong> {{ searchParams.startDate }} - {{ searchParams.endDate }}</p>
          <p><strong>Fechas formateadas:</strong> {{ debugDates.startDateFormatted }} - {{ debugDates.endDateFormatted }}</p>
          <p><strong>Noches calculadas:</strong> {{ getNightsCount() }}</p>
          <p><strong>Habitación ID:</strong> {{ searchParams.roomId }}</p>
          <p><strong>Subtotal:</strong> ${{ getSubtotal() }}</p>
          <p><strong>IVA:</strong> ${{ getIva().toFixed(2) }}</p>
          <p><strong>Total:</strong> ${{ getTotal().toFixed(2) }}</p>
          <p><strong>Cliente seleccionado:</strong> {{ selectedCustomerId }}</p>
          <p><strong>Stripe configurado:</strong> Integración con Stripe Elements activa</p>
        </div>

        <!-- Mensaje de éxito -->
        <div *ngIf="reservationCreated" class="px-4 py-3 bg-green-100 border border-green-400 text-green-700 rounded">
          ¡Reserva creada exitosamente! Redirigiendo a la página principal...
        </div>

        <form [formGroup]="reservationForm" (ngSubmit)="onSubmit()">
          <h3 class="text-[#0d171b] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Detalles de la Habitación</h3>
          <div class="p-4 grid grid-cols-[20%_1fr] gap-x-6">
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cfdfe7] py-5">
              <p class="text-[#4c809a] text-sm font-normal leading-normal">Tipo de Habitación</p>
              <p class="text-[#0d171b] text-sm font-normal leading-normal">{{ room?.type || 'Cargando...' }}</p>
            </div>
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cfdfe7] py-5">
              <p class="text-[#4c809a] text-sm font-normal leading-normal">Check-in</p>
              <p class="text-[#0d171b] text-sm font-normal leading-normal">{{ getCheckInDate() }}</p>
            </div>
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cfdfe7] py-5">
              <p class="text-[#4c809a] text-sm font-normal leading-normal">Check-out</p>
              <p class="text-[#0d171b] text-sm font-normal leading-normal">{{ getCheckOutDate() }}</p>
            </div>
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cfdfe7] py-5">
              <p class="text-[#4c809a] text-sm font-normal leading-normal">Noches</p>
              <p class="text-[#0d171b] text-sm font-normal leading-normal">{{ getNightsCount() }} noches</p>
            </div>
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cfdfe7] py-5">
              <p class="text-[#4c809a] text-sm font-normal leading-normal">Precio por Noche</p>
              <p class="text-[#0d171b] text-sm font-normal leading-normal">${{ room?.price || 0 }}</p>
            </div>
          </div>
          <h3 class="text-[#0d171b] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Cliente</h3>
          <div class="px-4 space-y-4"> 
            <!-- Selector de Cliente -->
            <!--<div>
              <label class="block text-[#0d171b] text-base font-medium leading-normal pb-2">Seleccionar Cliente *</label>
              <select 
                [value]="selectedCustomerId || ''"
                (change)="onCustomerSelect($event)"
                class="form-input w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d171b] focus:outline-0 focus:ring-0 border border-[#cfdfe7] bg-slate-50 focus:border-[#13a4ec] h-12 p-3 text-base font-normal leading-normal"
              >
                <option value="">-- Selecciona un cliente --</option>
                <option *ngFor="let customer of customers" [value]="customer.id">
                  {{ customer.name }} {{ customer.lastName }} - {{ customer.email }}
                </option>
              </select>
              <div *ngIf="!selectedCustomerId" class="text-red-500 text-sm mt-1">
                Debes seleccionar un cliente
              </div>
              <div *ngIf="selectedCustomerId && customer" class="text-green-600 text-sm mt-1">
                ✓ Cliente seleccionado automáticamente
              </div>
            </div>-->

            <!-- Información del Cliente Seleccionado -->
            <div *ngIf="selectedCustomerId && customer" class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <h4 class="font-bold text-blue-800 mb-2">Cliente Seleccionado:</h4>
              <p><strong>Nombre:</strong> {{ customer.name }} {{ customer.lastName }}</p>
              <p><strong>Email:</strong> {{ customer.email }}</p>
              <p><strong>Teléfono:</strong> {{ customer.phone }}</p>
            </div>
          </div>

          <h3 class="text-[#0d171b] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Información de la Mascota</h3>
          <div class="px-4 space-y-4">
            <!-- Información sobre la mascota -->
            <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
              <p class="text-sm text-green-800">
                <strong>Nota:</strong> Por favor, proporciona la información de la mascota que se hospedará en la habitación.
              </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-[#0d171b] text-base font-medium leading-normal pb-2">Nombre de la Mascota *</label>
                <input
                  formControlName="petName"
                  placeholder="Ej: Max, Luna, Rocky..."
                  class="form-input w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d171b] focus:outline-0 focus:ring-0 border border-[#cfdfe7] bg-slate-50 focus:border-[#13a4ec] h-12 placeholder:text-[#4c809a] p-3 text-base font-normal leading-normal"
                />
                <div *ngIf="reservationForm.get('petName')?.invalid && reservationForm.get('petName')?.touched" class="text-red-500 text-sm mt-1">
                  Nombre de la mascota requerido
                </div>
              </div>
              <div>
                <label class="block text-[#0d171b] text-base font-medium leading-normal pb-2">Raza de la Mascota *</label>
                <input
                  formControlName="petBreed"
                  placeholder="Ej: Golden Retriever, Persa, Pastor Alemán..."
                  class="form-input w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d171b] focus:outline-0 focus:ring-0 border border-[#cfdfe7] bg-slate-50 focus:border-[#13a4ec] h-12 placeholder:text-[#4c809a] p-3 text-base font-normal leading-normal"
                />
                <div *ngIf="reservationForm.get('petBreed')?.invalid && reservationForm.get('petBreed')?.touched" class="text-red-500 text-sm mt-1">
                  Raza de la mascota requerida
                </div>
              </div>
            </div>
          </div>

          <h3 class="text-[#0d171b] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Servicios Adicionales</h3>
          <div class="px-4">
            <div *ngFor="let service of additionalServices" class="flex gap-x-3 py-3 flex-row">
              <input
                type="checkbox"
                [checked]="service.selected"
                (change)="toggleService(service.id)"
                class="h-5 w-5 rounded border-[#cfdfe7] border-2 bg-transparent text-[#13a4ec] checked:bg-[#13a4ec] checked:border-[#13a4ec] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#cfdfe7] focus:outline-none"
              />
              <p class="text-[#0d171b] text-base font-normal leading-normal">{{ service.name }} (+${{ service.price }})</p>
            </div>
          </div>
          <h3 class="text-[#0d171b] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Información de Pago</h3>
          
          <!-- Información de tarjetas de prueba -->
          <div class="px-4 py-3 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded mb-4">
            <h4 class="font-bold mb-2">Modo de Prueba - Validaciones Desactivadas:</h4>
            <ul class="text-sm space-y-1">
              <li><strong>Número de tarjeta:</strong> Cualquier número con al menos 4 dígitos (ej: 1234)</li>
              <li><strong>Fecha de vencimiento:</strong> Cualquier texto que contenga números (ej: 12/25, 01/30, etc.)</li>
              <li><strong>CVV:</strong> Cualquier número (ej: 123, 456, 789)</li>
              <li><strong>Nombre del titular:</strong> Cualquier texto</li>
            </ul>
            <p class="text-xs mt-2 italic">Las validaciones estrictas están desactivadas para pruebas</p>
          </div>
          <div class="px-4 space-y-4">
            <!-- Información de Pago con Stripe Elements -->
            <div>
              <label class="block text-[#0d171b] text-base font-medium leading-normal pb-2">Información de la Tarjeta *</label>
              <div id="card-element" class="form-input w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d171b] focus:outline-0 focus:ring-0 border border-[#cfdfe7] bg-slate-50 focus:border-[#13a4ec] h-12 p-3 text-base font-normal leading-normal">
                <!-- Stripe Elements se montará aquí -->
              </div>
              <div id="card-errors" class="text-red-500 text-sm mt-1" role="alert">
                <!-- Los errores de Stripe aparecerán aquí -->
              </div>
            </div>

            <!-- Nombre del Titular -->
            <div>
              <label class="block text-[#0d171b] text-base font-medium leading-normal pb-2">Nombre del Titular *</label>
              <input
                formControlName="cardholderName"
                placeholder="Nombre como aparece en la tarjeta"
                class="form-input w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d171b] focus:outline-0 focus:ring-0 border border-[#cfdfe7] bg-slate-50 focus:border-[#13a4ec] h-12 placeholder:text-[#4c809a] p-3 text-base font-normal leading-normal"
              />
              <div *ngIf="reservationForm.get('cardholderName')?.invalid && reservationForm.get('cardholderName')?.touched" class="text-red-500 text-sm mt-1">
                Nombre del titular requerido
              </div>
            </div>

            <!-- Observaciones -->
            <div>
              <label class="block text-[#0d171b] text-base font-medium leading-normal pb-2">Observaciones</label>
              <textarea
                formControlName="observation"
                placeholder="Observaciones adicionales (opcional)"
                class="form-input w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d171b] focus:outline-0 focus:ring-0 border border-[#cfdfe7] bg-slate-50 focus:border-[#13a4ec] h-12 placeholder:text-[#4c809a] p-3 text-base font-normal leading-normal"
                rows="3"
              ></textarea>
            </div>
          </div>
          <h3 class="text-[#0d171b] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Resumen de Costos</h3>
          <div class="p-4 grid grid-cols-[20%_1fr] gap-x-6">
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cfdfe7] py-5">
              <p class="text-[#4c809a] text-sm font-normal leading-normal">{{ room?.type || 'Habitación' }} ({{ getNightsCount() }} noches)</p>
              <p class="text-[#0d171b] text-sm font-normal leading-normal">${{ room?.price || 0 }}/noche</p>
            </div>
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cfdfe7] py-5">
              <p class="text-[#4c809a] text-sm font-normal leading-normal">Subtotal (Habitación)</p>
              <p class="text-[#0d171b] text-sm font-normal leading-normal">${{ (room?.price || 0) * getNightsCount() }}</p>
            </div>
            <ng-container *ngFor="let service of additionalServices">
              <div *ngIf="service.selected" class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cfdfe7] py-5">
                <p class="text-[#4c809a] text-sm font-normal leading-normal">{{ service.name }}</p>
                <p class="text-[#0d171b] text-sm font-normal leading-normal">${{ service.price }}</p>
              </div>
            </ng-container>
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cfdfe7] py-5">
              <p class="text-[#4c809a] text-sm font-normal leading-normal">Subtotal</p>
              <p class="text-[#0d171b] text-sm font-normal leading-normal">${{ getSubtotal() }}</p>
            </div>
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cfdfe7] py-5">
              <p class="text-[#4c809a] text-sm font-normal leading-normal">IVA (12%)</p>
              <p class="text-[#0d171b] text-sm font-normal leading-normal">${{ getIva().toFixed(2) }}</p>
            </div>
            <div class="col-span-2 grid grid-cols-subgrid border-t-2 border-t-[#13a4ec] py-5">
              <p class="text-[#0d171b] text-base font-bold leading-normal">Total</p>
              <p class="text-[#0d171b] text-base font-bold leading-normal">${{ getTotal().toFixed(2) }}</p>
            </div>
          </div>

          <div class="flex px-4 py-3">
            <button
              type="submit"
              [disabled]="loading || reservationCreated"
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 flex-1 bg-[#13a4ec] text-slate-50 text-base font-bold leading-normal tracking-[0.015em] disabled:bg-gray-400 disabled:cursor-not-allowed"
            >
              <span *ngIf="loading" class="truncate">Creando Reserva...</span>
              <span *ngIf="!loading && !reservationCreated" class="truncate">Procesar Pago y Reservar</span>
              <span *ngIf="reservationCreated" class="truncate">Reserva Creada</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <app-footer></app-footer>
</div>
